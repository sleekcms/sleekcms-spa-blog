<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="description" content="A minimal single-page app blog powered by SleekCMS" />
    <meta name="theme-color" content="#1a1a2e" />
    <link rel="icon" href="/sleekcms.svg" type="image/svg+xml" />
    <title>Loading…</title>

    <!-- Preconnect to CDN origins -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
    <link rel="preconnect" href="https://unpkg.com" crossorigin />

    <!-- Non-blocking CSS with preload pattern -->
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2.1.1/css/pico.classless.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'" />
    <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2.1.1/css/pico.classless.min.css" /></noscript>

    <!-- Critical inline CSS for initial render -->
    <style>
      *,*::before,*::after{box-sizing:border-box}
      body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;line-height:1.5;margin:0;padding:1rem 1rem 0}
      h1{font-size:2rem;margin:0 0 .25rem}
      a{color:#1095c1;text-decoration:none}
      a:hover{text-decoration:underline}
      .secondary{color:#6c757d}
      header,main,footer{max-width:48rem;margin:0 auto}
      #app{min-height:50vh}
    </style>
  </head>

  <body>
    <header style="display: flex; align-items: flex-start; justify-content: space-between">
        <div>
      <h1 id="siteTitle" style="font-weight: 400">…</h1>
      <small id="siteSubtitle"></small>
      </div>
      <nav><a id="homeLink">Home</a></nav>
    </header>
    <main>
      <article id="app" style="min-height:50vh">
        <div class="secondary">Loading…</div>
      </article>
    </main>

    <footer style="text-align: center;">
      <small>View source — this entire site is just this one HTML file.</small>
      <br/>
      <small>
        <a href="https://github.com/sleekcms/sleekcms-spa-blog" target="_blank" rel="noopener">View Source</a>
        •
        <a href="/vue" target="_blank">Using Vue.js</a>
        •
        <a href="https://github.com/sleekcms/sleekcms-next-blog" target="_blank" rel="noopener">Use Next.js</a>
        •
        <a href="https://app.sleekcms.com" target="_blank" rel="noopener">Login to SleekCMS</a>
      </small>
    </footer>

    <!-- SleekCMS client from unpkg (loaded async, init waits for it) -->
    <script src="https://unpkg.com/@sleekcms/client" id="sleekcms-script"></script>

    <script>
      // ====== CONFIG ======
      // Put your SleekCMS content site token here. Register at https://app.sleekcms.com/
      const SITE_TOKEN = "pub-2kzel-5d6ab732e37c4a2ea36ae91ccc509577";
      const ENV = "latest";
      // SPA mode: true = use history.pushState, false = use hash routing
      const SPA = true; // Set to true to enable history routing

      // ====== STATE ======
      let client = null;
      let homePage = null;
      let blogPages = []; // list under /blog
      let pagesByPath = new Map(); // "/blog/post1" => page

      const elApp = document.getElementById("app");
      const elSiteTitle = document.getElementById("siteTitle");
      const elSiteSubtitle = document.getElementById("siteSubtitle");

      // ====== HELPERS ======
      function normalizePath(p) {
        if (!p) return "/";
        if (!p.startsWith("/")) p = "/" + p;
        if (p.length > 1 && p.endsWith("/")) p = p.slice(0, -1);
        return p;
      }


      function getCurrentPath() {
        if (SPA) {
          const raw = location.pathname + location.search;
          const pathOnly = raw.split("?")[0] || "/";
          return normalizePath(pathOnly);
        } else {
          const raw = (location.hash || "#/" ).slice(1);
          const pathOnly = raw.split("?")[0] || "/";
          return normalizePath(pathOnly);
        }
      }

      function escapeHtml(str) {
        return String(str).replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;").replaceAll('"', "&quot;").replaceAll("'", "&#039;");
      }

      function setMeta(options = {}) {
        const { title, description, image, url } = options;
        const siteTitle = homePage && homePage.title ? String(homePage.title) : "My Blog";
        const siteDescription = homePage && homePage.sub_title ? String(homePage.sub_title) : "A minimal single-page app blog powered by SleekCMS";

        // Page title
        const pageTitle = title ? `${title} | ${siteTitle}` : siteTitle;
        document.title = pageTitle;

        // Site header
        elSiteTitle.textContent = siteTitle;
        elSiteSubtitle.textContent = siteDescription;

        // Meta description
        let metaDesc = document.querySelector('meta[name="description"]');
        if (!metaDesc) {
          metaDesc = document.createElement('meta');
          metaDesc.name = 'description';
          document.head.appendChild(metaDesc);
        }
        metaDesc.content = description || siteDescription;

        // Canonical URL
        const canonicalUrl = url || location.href;
        let linkCanonical = document.querySelector('link[rel="canonical"]');
        if (!linkCanonical) {
          linkCanonical = document.createElement('link');
          linkCanonical.rel = 'canonical';
          document.head.appendChild(linkCanonical);
        }
        linkCanonical.href = canonicalUrl;

        // Open Graph tags
        const ogTags = {
          'og:title': title || siteTitle,
          'og:description': description || siteDescription,
          'og:url': canonicalUrl,
          'og:type': title ? 'article' : 'website',
          'og:image': image || ''
        };

        for (const [property, content] of Object.entries(ogTags)) {
          let meta = document.querySelector(`meta[property="${property}"]`);
          if (!meta) {
            meta = document.createElement('meta');
            meta.setAttribute('property', property);
            document.head.appendChild(meta);
          }
          if (content) {
            meta.content = content;
          } else if (property === 'og:image') {
            meta.remove(); // Remove empty og:image
          }
        }

        // Twitter Card tags
        const twitterTags = {
          'twitter:card': image ? 'summary_large_image' : 'summary',
          'twitter:title': title || siteTitle,
          'twitter:description': description || siteDescription,
          'twitter:image': image || ''
        };

        for (const [name, content] of Object.entries(twitterTags)) {
          let meta = document.querySelector(`meta[name="${name}"]`);
          if (!meta) {
            meta = document.createElement('meta');
            meta.name = name;
            document.head.appendChild(meta);
          }
          if (content) {
            meta.content = content;
          } else if (name === 'twitter:image') {
            meta.remove();
          }
        }
      }

      // Legacy wrapper for compatibility
      function setTitle(text) {
        setMeta({ title: text });
      }

      function isBlogPostPath(p) {
        const path = normalizePath(p);
        return path.startsWith("/blog/") && path.length > "/blog/".length;
      }

      // ====== RENDERING ======
      function renderError(message, detail) {
        const homeHref = SPA ? "/" : "#/";
        elApp.innerHTML = `
          <article>
            <strong>Error:</strong> ${escapeHtml(message)}
            ${detail ? `<pre class="secondary">${escapeHtml(detail)}</pre>` : ""}
            <div style="margin-top:1rem;"><a class="secondary" href="${homeHref}">Go back to home</a></div>
          </article>
        `;
      }

      function renderHome() {
        const siteTitle = homePage && homePage.title ? String(homePage.title) : "My Blog";
        const siteDescription = homePage && homePage.sub_title ? String(homePage.sub_title) : "A minimal single-page app blog powered by SleekCMS";
        setMeta({
          title: null,
          description: siteDescription,
          url: location.origin + '/'
        });

        const posts = blogPages
          .filter((p) => isBlogPostPath(p._path))
          .slice()
          .sort((a, b) => String(a.title || "").localeCompare(String(b.title || "")));

        const makeHref = (path) => SPA ? encodeURI(path) : `#${encodeURI(path)}`;
        const listHtml = posts.length
          ? `<ul>
              ${posts
                .map((p) => {
                  const path = normalizePath(p._path);
                  const title = p.title || path;
                  return `
                  <li>
                    <a href="${makeHref(path)}">
                      ${escapeHtml(title)}
                    </a>
                  </li>
                `;
                })
                .join("")}
            </ul>`
          : `<div class="secondary">No blog posts found under <code>/blog</code>.</div>`;

        elApp.innerHTML = `
          <section>
            ${listHtml}
          </section>
        `;
      }

      function renderPost(path) {
        const page = pagesByPath.get(path);

        if (!page) {
          renderError("Post not found.", `No page found for path: ${path}`);
          return;
        }

        const title = page.title || path;
        
        // Extract description from content (first 160 chars of text)
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = page.content || '';
        const textContent = tempDiv.textContent || tempDiv.innerText || '';
        const description = textContent.trim().slice(0, 160).replace(/\s+/g, ' ').trim() + (textContent.length > 160 ? '…' : '');

        setMeta({
          title: title,
          description: page.description || description || null,
          image: page.image && page.image.url ? page.image.url : null,
          url: location.origin + path
        });

        elApp.innerHTML = `
            <h2>${escapeHtml(title)}</h2>
            ${
              page.image && page.image.url
                ? `
              <img
                src="${escapeHtml(page.image.url)}"
                alt="${escapeHtml(title)}"
                style="width:100%; max-height:360px; object-fit:cover; border-radius:var(--pico-border-radius, 0.5rem); margin-bottom:1rem;"
                loading="lazy"
              />
            `
                : ``
            }
            <div id="postContent" class="content" style="margin-top:1rem;"></div>
        `;

        document.getElementById("postContent").innerHTML = page.content || `<p>No content.</p>`;
      }


      function renderRoute() {
        if (!client) return;
        const path = getCurrentPath();
        if (path === "/") return renderHome();
        return renderPost(path);
      }


      async function loadContent() {
        if (!window.SleekCMS || !window.SleekCMS.createSyncClient) {
          return renderError("SleekCMS client not available.", "Failed to load https://unpkg.com/@sleekcms/client");
        }

        elApp.innerHTML = `<div>Loading content from SleekCMS…</div>`;

        try {
          client = await window.SleekCMS.createSyncClient({
            siteToken: SITE_TOKEN,
            env: ENV || "latest",
            resolveEnv: true,
          });

          homePage = client.getPage("/"); // { title, ... }
          blogPages = client.getPages("/blog"); // [ { title, image, content, _path, _slug }, ... ]

          // Build index for routing
          pagesByPath = new Map();
          if (homePage) pagesByPath.set("/", { ...homePage, _path: "/" });

          for (const p of blogPages || []) {
            const np = normalizePath(p._path);
            pagesByPath.set(np, { ...p, _path: np });
          }

          // Ensure we always have a hash or path
          if (SPA) {
            if (location.pathname === "/") {
              history.replaceState({}, "", "/");
            }
          } else {
            if (!location.hash) location.hash = "#/";
          }
          renderRoute();
        } catch (err) {
          client = null;
          renderError("Failed to load content.", err?.message || String(err));
        }
      }

      if (SPA) {
        // Set Home link href
        document.getElementById("homeLink").setAttribute("href", "/");
        window.addEventListener("popstate", renderRoute);
        // Delegate click events for internal links
        document.body.addEventListener("click", function (e) {
          const a = e.target.closest("a");
          if (a && a.getAttribute("href") && a.getAttribute("href").startsWith("/")) {
            e.preventDefault();
            history.pushState({}, "", a.getAttribute("href"));
            renderRoute();
          }
        });
      } else {
        // Set Home link href
        document.getElementById("homeLink").setAttribute("href", "#/" );
        window.addEventListener("hashchange", renderRoute);
      }

      // Start
      loadContent();
    </script>
  </body>
</html>
